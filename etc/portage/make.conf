#########################################################################################################################
#   Никита Юрьевич Казаков                                                                                              #
#   21.02.2023                                                                                                          #
#   kazak715@yandex.ru                                                                                                  #
#########################################################################################################################


#########################################################################################################################
#   ПРОЦЕССОР                                                                                                           #
#########################################################################################################################
NTHREADS="12" 
CPU_FLAGS_X86="${CPU_FLAGS_X86} fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx"
CPU_FLAGS_X86="${CPU_FLAGS_X86} fxsr sse sse2 sse3 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good"
CPU_FLAGS_X86="${CPU_FLAGS_X86} nopl nonstop_tsc cpuid extd_apicid aperfmperf rapl pni pclmulqdq monitor ssse3 fma cx16"
CPU_FLAGS_X86="${CPU_FLAGS_X86} sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic"
CPU_FLAGS_X86="${CPU_FLAGS_X86} cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ibs skinit wdt tce topoext"
CPU_FLAGS_X86="${CPU_FLAGS_X86} perfctr_core perfctr_nb bpext perfctr_llc mwaitx cpb cat_l3 cdp_l3 hw_pstate"
CPU_FLAGS_X86="${CPU_FLAGS_X86} ssbd mba ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 erms invpcid cqm rdt_a"
CPU_FLAGS_X86="${CPU_FLAGS_X86} rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 xsaves cqm_llc"
CPU_FLAGS_X86="${CPU_FLAGS_X86} cqm_occup_llc cqm_mbm_total cqm_mbm_local clzero irperf xsaveerptr rdpru wbnoinvd arat"
CPU_FLAGS_X86="${CPU_FLAGS_X86} npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter"
CPU_FLAGS_X86="${CPU_FLAGS_X86} pfthreshold avic v_vmsave_vmload vgif v_spec_ctrl umip pku ospke vaes vpclmulqdq rdpid"
CPU_FLAGS_X86="${CPU_FLAGS_X86} overflow_recov succor smca fsrm"
#########################################################################################################################


#########################################################################################################################
#   КОМПИЛЯТОР СБОРКА                                                                                                   #
#########################################################################################################################
MY_WARN="-Wformat=2"                    # Проверяет аргументы нулевого формата для нескольких функций, также
                                        # подразумевает-Wnonnull. Некоторые аспекты этого уровня проверки формата можно
                                        # отключить с помощью следующих опций: -Wno-format-содержит-nul,
                                        # -Wno-format-extra-args, и-Wno-формат нулевой длины. -Wall.
                                        # -Wformat -Wformat-nonliteral -Wformat-security -Wformat-y2k
MY_WARN="${MY_WARN} -Wformat-security"  # Отклонить потенциально небезопасные аргументы строки формата
MY_WARN="${MY_WARN} -Wtrampolines"      # Предупреждать о трамплинах, созданных для указателей на вложенные функции.
                                        # Трамплин — это небольшой фрагмент данных или кода, который создается во время
                                        # выполнения в стеке, когда берется адрес вложенной функции, и используется для
                                        # косвенного вызова вложенной функции. Для некоторых целей он состоит только из
                                        # данных и поэтому не требует специальной обработки. Но для большинства целей он
                                        # состоит из кода и, следовательно, требует, чтобы стек был выполнен исполняемым,
                                        # чтобы программа работала правильно.
#########################################################################################################################
                                                # ВКЛЮЧЁН ПО УМОЛЧАНИЮ кроме  одного исключения
MY_HARD="-D_FORTIFY_SOURCE=3"                   # обнаружение переполнения буфера во время выполнения
MY_HARD="${MY_HARD} -Wp,-D_FORTIFY_SOURCE=3"    # https://www.reddit.com/r/archlinux/comments/o3fqy4/problem_with_building_glibc/
MY_HARD="${MY_HARD} -D_GLIBCXX_ASSERTIONS"      # проверка границ во время выполнения для строк и контейнеров C++
                                                # ВКЛЮЧЁН ПО УМОЛЧАНИЮ
MY_HARD="${MY_HARD} -fstack-protector-strong"   # защита от разрушения стека
                                                # ВКЛЮЧЁН ПО УМОЛЧАНИЮ
MY_HARD="${MY_HARD} -fstack-clash-protection"   # повышена надежность обнаружения переполнения стека
                                                # ВКЛЮЧЁН ПО УМОЛЧАНИЮ
MY_HARD="${MY_HARD} -fcf-protection"            # защита целостности потока управления
MY_HARD="${MY_HARD} -fexceptions"               # Включить отмену потоков на основе таблиц. Рекомендуется для защиты
                                                # многопоточного кода C и C++. Без него реализация обработчиков отмены
                                                # потоков (представленных pthread_cleanup_push) использует полностью
                                                # незащищенный указатель функции в стеке.
MY_HARD="${MY_HARD} -fvisibility=hidden"        # вы сообщаете GCC, что каждое объявление, не отмеченное явно атрибутом
                                                # видимости, имеет скрытую видимость.
MY_HARD="${MY_HARD} -fasynchronous-unwind-tables" # Повышенная надежность обратных трасс

#-fvtable-verify=* https://forums.gentoo.org/viewtopic-p-8711798.html
#########################################################################################################################
MY_ON_LTO="-flto=${NTHREADS}"              # включить и задать количество процессоров
MY_DEVIRTLTO="-fdevirtualize-at-ltrans"    # отключить межмодульную виртуализацию?
MY_FAT_LTO="-ffat-lto-objects"             # размещать и машинный код и объектный код для поддержки линковки с объектом
                                           # без LTO
MY_NO_FAT_LTO="-fno-fat-lto-objects"
# С LTO_PART=1to1 не собираются пакеты, по крайней мере toolchain
#LTO_PART="-flto-partition=1to1"        # Один раздел LTO на одну единицу компиляции. По умлочанию "balance"
MY_LTO_PART="-flto-partition=one"          # Единственный раздел LTO на всю программу. По умлочанию "balance"
MY_LTO="${MY_ON_LTO} ${MY_DEVIRTLTO} ${MY_FAT_LTO} ${MY_LTO_PART}"
#########################################################################################################################
MY_RUST_LTO="-C embed-bitcode=on"
MY_RUST_LTO="${MY_RUST_LTO} -C lto=thin"
MY_RUST_LTO="${MY_RUST_LTO} -C linker-plugin-lto=on"
#########################################################################################################################
MY_GRAPHITE="-fgraphite-identity -floop-nest-optimize"
MY_NOPLT="-fno-plt"                # не вставлять таблицу переходов (jmp's)
MY_IPAPTA="-fipa-pta"              # межпроцедурные оптимизации https://kristerw.blogspot.com/2017/06/fipa-pta.html
MY_VECTORIZE="-ftree-vectorize"    # векторизация циклов
#########################################################################################################################
# Было BASE_CFLAGS, но sys-apps/xdg-desktop-portal в своём сценарии сборки использует одноимённую переменную
MY_BASE_CFLAGS="-march=native -O2 -fomit-frame-pointer -flimit-function-alignment"
MY_BASE_CFLAGS="${MY_BASE_CFLAGS} -msse -msse2 -msse3 -mssse3 -msse4.1 -msse4.2 -mmmx"
MY_BASE_CFLAGS="${MY_BASE_CFLAGS} -fuse-linker-plugin -pipe -s -g0"
#########################################################################################################################
MY_RUST_BASE="                -C target-cpu=native"
MY_RUST_BASE="${MY_RUST_BASE} -C debug-assertions=off"
MY_RUST_BASE="${MY_RUST_BASE} -C debuginfo=0"
MY_RUST_BASE="${MY_RUST_BASE} -C link-dead-code=off"
MY_RUST_BASE="${MY_RUST_BASE} -C strip=symbols"
MY_RUST_BASE="${MY_RUST_BASE} -C opt-level=3"
MY_RUST_BASE="${MY_RUST_BASE} -C overflow-checks=on"
#########################################################################################################################
MY_COMMON_CFLAGS="                    ${MY_BASE_CFLAGS}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_HARD}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_NOPLT}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_IPAPTA}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_VECTORIZE}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_GRAPHITE}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_LTO}"
MY_COMMON_CFLAGS="${MY_COMMON_CFLAGS} ${MY_WARN}"
#########################################################################################################################
MY_LD_HARD="-Wl,-O1"
MY_LD_HARD="${MY_LD_HARD} -Wl,-O2"
#LD_HARD="${LD_HARD} -Wl,-threads=${NTHREADS}" # не понимает линкер gcc такого
MY_LD_HARD="${MY_LD_HARD} -Wl,--sort-common"    # сортировка блоков в секциях по размеру, чтобы компактнее расположить
MY_LD_HARD="${MY_LD_HARD} -Wl,--strip-all"      # удалить все лишние символы
MY_LD_HARD="${MY_LD_HARD} -Wl,--as-needed"      # линковать только действительно нужное
MY_LD_HARD="${MY_LD_HARD} -Wl,-z,noexecstack"   # стек помечен как не исполняемый
                                                # ВКЛЮЧЁН ПО УМОЛЧАНИЮ
MY_LD_HARD="${MY_LD_HARD} -Wl,-z,relro"         # сегменты только для чтения после перемещения
#########################################################################################################################
# Эти флаги тоже линкер gcc не понимает
#LD_LTO="-flto -flto=thin -fuse-linker-plugin"
#LD_LTO="-Wl,-flto=${NTHREADS} -Wl,-fuse-linker-plugin"
#########################################################################################################################
CFLAGS="${CFLAGS} ${MY_COMMON_FLAGS}"              # C
CXXFLAGS="${CXXFLAGS} ${MY_COMMON_FLAGS}"          # C++
FCFLAGS="${FCFLAGS} ${MY_COMMON_FLAGS}"            # Fortran
FFLAGS="${FFLAGS} ${MY_COMMON_FLAGS}"              # Fortran 77

BOOT_CFLAGS="${BOOT_CFLAGS} ${MY_COMMON_FLAGS}"
T_CFLAGS="${T_CFLAGS} ${BOOT_CFLAGS}"

LDFLAGS="${LDFLAGS} ${MY_LD_HARD}"

RUSTFLAGS="${RUSTFLAGS} ${MY_RUST_BASE} ${MY_RUST_LTO}"
#########################################################################################################################


#########################################################################################################################
#   ЖЕЛЕЗО                                                                                                              #
#########################################################################################################################
VIDEO_CARDS="nvidia radeon amdgpu radeonsi d3d12 v3d"
INPUT_DEVICE="libinput"
GRUB_PLATFORMS="efi-64"
#########################################################################################################################


#########################################################################################################################
#   ОПЦИИ СОФТА                                                                                                         #
#########################################################################################################################
AUTOCLEAN="yes"
ACCEPT_KEYWORDS="amd64" # после установки сменить на amd64
ACCEPT_LICENSE="*"
TKBBER_PLUGINS="cyrillize"
LINGUAS="ru ru_RU"
LANGUAGE="${LANGUAGE} ${LINGUAS}"
L10N="${LINGUAS}"
LC_ALL="ru_RU.UTF-8"
LLVM_TARGETS="${LLVM_TARGETS} AMDGPU NVPTX WebAssembly"
LIBREOFFICE_EXTENSIONS="nlpsolver wiki-publisher scripting-javascript"
RUBY_TARGETS="ruby30"
PYTHON_TARGETS="python3_11 python3_10"
PYTHON_SINGLE_TARGET="python3_10"
ADA_TARGET="gcc_12" #gnat_2021" # gcc_12 gcc_12_2_0"
FONT_TYPES="${FONT_TYPES} otf ttf"
PAX_MARKINGS="XT PT"
#########################################################################################################################


#########################################################################################################################
#   Опции PORTAGE                                                                                                       #
#########################################################################################################################
PORTAGE_NICENESS="19"
PORTAGE_IONICE_COMMAND="ionice -c 3 -p \${PID}"
MAKEOPTS="--jobs ${NTHREADS} --load-average 13"
CARGO_BUILD_JOBS="${NTHREADS}"
PORTAGE_COMPRESS="xz"
PORTAGE_COMPRESS_FLAGS="--check=crc64 -9e --threads=${NTHREADS}"
BINPKG_COMPRESS="${PORTAGE_COMPRESS}"
BINPKG_COMPRESS_FLAGS="${PORTAGE_COMPRESS_FLAGS}"
BINPKG_FORMAT="gpkg"
PORTAGE_ELOG_CLASSES="warn error" # log”
PORTAGE_ELOG_SYSTEM="echo save"

CMAKE_MAKEFILE_GENERATOR=ninja

LC_MESSAGES=ru

EMERGE_DEFAULT_OPTS="--verbose --keep-going --quiet-build --verbose-conflicts --ask"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg --binpkg-respect-use=n"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --quiet-fail"

FEATURES="${FEATURES} buildpkg protect-owned fakeroot metadata-transfer multilib-strict news parallel-fetch sandbox"
FEATURES="${FEATURES} userfetch userpriv usersandbox usersync split-elog preserve-libs"
FEATURES="${FEATURES} collision-protect"

NOCOLOR="false"
DISTDIR="/var/cache/distfiles"
PKGDIR="/var/cache/binpkgs"
GENTOO_MIRRORS="https://mirror.yandex.ru/gentoo-distfiles"
#########################################################################################################################


#########################################################################################################################
#   USE-flags Комплектация ПО (Софта)                                                                                   #
# Добавлено - выше, удалено - ниже                                                                                      #
#########################################################################################################################
# A B C D E F G H I J K L M N O P Q R S T U V W X Y Z                                                                   #
#   Для GNOME на OpenRC                                                                                                 #
#=======================================================================================================================#
USE="${USE} a52 aac acpi alsa amd64"
USE="${USE} bluetooth branding"
USE="${USE} cairo cdda cdr colord"
USE="${USE} dbus dts dvd dvdr"
USE="${USE} elogind eds encode evo exif"
USE="${USE} gif gnome gnome-keyring gnome-online-accounts gstreamer gtk gui gsettings gphoto2 glade gtk3 gimp"
USE="${USE} introspection"
USE="${USE} jpeg"
USE="${USE} lcms libnotify libsecret libtirpc"
USE="${USE} mad mng mp3 mp4 mpeg mime  multilib"
USE="${USE} nautilus ncurses networkmanager nls nptl"
USE="${USE} opengl openmp"
USE="${USE} pam pango pcre pdf peer_perms png policykit ppds pulseaudio"
USE="${USE} readline"
USE="${USE} seccomp sound spell split-usr ssl startup-notification svg sysprof sdl"
USE="${USE} test-rust tiff tracker truetype"
USE="${USE} ubac udev udisks unconfined unicode upower usb"
USE="${USE} vorbis"
USE="${USE} wxwidgets"
USE="${USE} x264 xattr xcb xft xml xv xvid X509"
USE="${USE} zlib"
#########################################################################################################################
# A B C D E F G H I J K L M N O P Q R S T U V W X Y Z                                                                   #
#   Для SELinux и hardened                                                                                              #
#=======================================================================================================================#
USE="${USE} peer_perms ubac unconfined"
USE="${USE} cet cer hardened"
#########################################################################################################################
# A B C D E F G H I J K L M N O P Q R S T U V W X Y Z                                                                   #
#   МОИ ФЛАГИ                                                                                                           #
#=======================================================================================================================#
USE="${USE} aptx archive apng all-sfx appindicator"
USE="${USE} blake2 bash-completion boost brotli bluray"
USE="${USE} custom-cflags clippy cups curl cacert cuda"
USE="${USE} djvu dv dvb d3d9" # dhcpcd у networkmanager есть свтроенный dhcp
USE="${USE} elfutils epub egl"
USE="${USE} fuse ffmpeg fontconfig fontforge fat flickr fbcon fam flac" # firebird"
USE="${USE} gnutls git googledrive gpm gles2 gcrypt gbm"
USE="${USE} hpn highlight heif hash-sysv-compat hddtemp hpn harfbuzz hunspell"
USE="${USE} idn icu imap ibus"
USE="${USE} jbig jemalloc jpeg2k"
USE="${USE} kbd"
USE="${USE} lto ldns lzma lm-sensors libass lame libvisual libsamplerate lzo lz4 lua52compat"
USE="${USE} mtp man matroska mime multitarget modemmanager"
USE="${USE} nftables natspec nvenc"
USE="${USE} openmp opencl openal oauth ogg openssl openh264 ocr"
USE="${USE} pgo pf-sources pipewire ptpax pipewire-alsa pdfimport proton playlist proprietary-codecs" # profile phonon"
USE="${USE} resolvconf rustfmt rust-analyzer raw rdesktop rustls rfc3779"
USE="${USE} savedconfig syslog scanner samba sound-server suid screencast smp svg sndfile sdl sendto" # share"
USE="${USE} threads tls-compression taglib theora terminal trayicon text tk telepathy"
USE="${USE} unknown-license uefi"
USE="${USE} vulkan v4l vpx vcd vnc vaapi vdpau" # vim-syntax
USE="${USE} wavpack wmf wifi wps webp wayland widevine"
USE="${USE} X509 x265 xxhash X xpm xvmc xvfb"
USE="${USE} zstd zeroconf zink" # zram" требует systemd # zeroconf?
USE="${USE} -binary -bindist"
#USE="${USE} -clang"
USE="${USE} -gtk-doc -games" # -gnome-online-accounts"
USE="${USE} -iptables" #-ibus
USE="${USE} -joystick"
USE="${USE} -kerberos"
USE="${USE} -native-cflags -nss"
#USE="${USE} -openssl"
#USE="${USE} -pf-sources"
USE="${USE} -qt5"
USE="${USE} -smartcard -systemd"
#USE="${USE} -vala"
#USE="${USE} -wext" # -wayland"
#########################################################################################################################
# A B C D E F G H I J K L M N O P Q R S T U V W X Y Z                                                                   #
#   ВРЕМЕННЫЕ ФЛАГИ                                                                                                     #
#=======================================================================================================================#
#USE="${USE} -gnome-keyring -X -gtk -gtk3 -gtk4 -vorbis -ogg -opengl -theora"
#USE="${USE} -cairo -bluetooth"
#########################################################################################################################
